<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>配置Nginx采集器 | W3A SOC</title> <meta name="generator" content="Jekyll v4.2.2" /> <meta property="og:title" content="配置Nginx采集器" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="W3A SOC 一个安全运维工作台" /> <meta property="og:description" content="W3A SOC 一个安全运维工作台" /> <link rel="canonical" href="http://localhost:4000/%E6%97%A5%E5%BF%97%E5%AE%A1%E8%AE%A1/%E9%85%8D%E7%BD%AENginx%E9%87%87%E9%9B%86%E5%99%A8" /> <meta property="og:url" content="http://localhost:4000/%E6%97%A5%E5%BF%97%E5%AE%A1%E8%AE%A1/%E9%85%8D%E7%BD%AENginx%E9%87%87%E9%9B%86%E5%99%A8" /> <meta property="og:site_name" content="W3A SOC" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="配置Nginx采集器" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"W3A SOC 一个安全运维工作台","headline":"配置Nginx采集器","url":"http://localhost:4000/%E6%97%A5%E5%BF%97%E5%AE%A1%E8%AE%A1/%E9%85%8D%E7%BD%AENginx%E9%87%87%E9%9B%86%E5%99%A8"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="http://localhost:4000/" class="site-title lh-tight"> W3A SOC </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="http://localhost:4000/" class="nav-list-link">W3A SOC</a></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/%E6%97%A5%E5%BF%97%E5%AE%A1%E8%AE%A1" class="nav-list-link">日志审计</a><ul class="nav-list "><li class="nav-list-item active"><a href="http://localhost:4000/%E6%97%A5%E5%BF%97%E5%AE%A1%E8%AE%A1/%E9%85%8D%E7%BD%AENginx%E9%87%87%E9%9B%86%E5%99%A8" class="nav-list-link active">配置Nginx采集器</a></li><li class="nav-list-item "><a href="http://localhost:4000/%E6%97%A5%E5%BF%97%E5%AE%A1%E8%AE%A1/%E9%85%8D%E7%BD%AEKafka%E9%87%87%E9%9B%86%E5%99%A8" class="nav-list-link">配置Kafka采集器</a></li></ul></li><li class="nav-list-item"><a href="http://localhost:4000/%E6%BC%8F%E6%B4%9E%E9%A3%8E%E9%99%A9%E7%AE%A1%E7%90%86" class="nav-list-link">漏洞风险管理</a></li><li class="nav-list-item"><a href="http://localhost:4000/W3A" class="nav-list-link">功能地图</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search W3A SOC" aria-label="Search W3A SOC" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="//github.com/smarttang/w3a_SOC" class="site-button" target="_blank" rel="noopener noreferrer" > 开始拉取项目 </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="http://localhost:4000/%E6%97%A5%E5%BF%97%E5%AE%A1%E8%AE%A1">日志审计</a></li> <li class="breadcrumb-nav-list-item"><span>配置Nginx采集器</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h2 id="演进洞察"> <a href="#演进洞察" class="anchor-heading" aria-labelledby="演进洞察"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 演进&amp;洞察 </h2> <p>现在经过几年的技术演进，我们不再自己造轮子自己写这个采集端，因为相对来讲不太稳健：</p> <ul> <li>容易崩，一旦崩了会带来各种问题，还得维护、排错，也不知道哪个地方出问题，说不定是语法，或者各种奇奇怪怪的场景。</li> <li>中间层不太稳健，量大的就出各种问题，取决于机器性能和日志处理的瓶颈。</li> </ul> <p>最好的方式还是基于现成的采集来实现，选型中有Flume、Logstash，也有Filebeat这些，看了下对比：<a href="https://blog.csdn.net/a934079371/article/details/107328732">参考指南</a>最终，因为分析工具是基于Golang的，而且我们整个工作台也是奔着云原生的方向去走，所以，我们在采集这端优先用Filebeat，主要洞察是：</p> <ul> <li>针对中小型的客户，比较好融合，基于Kafka实现，订阅消费的模式比较容易解耦。（正正合适，对业务0嵌入）</li> <li>针对中大型的客户，如日志量到PB级一天，这种基于Hadoop集群的模式，可以单独再聊，不在本文范畴里。（从画像来讲，这类客户极其罕见，真有，我们可以定制）</li> <li>Kafka相对稳健成熟的基础设施，不需要过多对比，什么性能指标、各种推理，客户不用有过多的顾虑，怕用一个不成熟的第三方，导致各种问题，怕自研的采集器要么不维护，要么不稳定，中立挺好，kafka大家都熟，没有顾虑。</li> <li>兼容容器集群（K8S）的场景，在容器中基于Filebeat采集有天然优势，这个在后续融合HIDS(平台后续具备的能力)的时候，就更加简单容易，天然结合。</li> </ul> <h2 id="配置解释"> <a href="#配置解释" class="anchor-heading" aria-labelledby="配置解释"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 配置&amp;解释 </h2> <p>从docker-compose的配置文件上，就能看到这个采集的用法。</p> <h3 id="filebeat基础配置"> <a href="#filebeat基础配置" class="anchor-heading" aria-labelledby="filebeat基础配置"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> filebeat基础配置 </h3> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>filebeat.inputs:
- type: log
  enabled: true
  fields:
    source: nginx_access_log
  paths:
    - /var/log/nginx/access*.log
  json.keys_under_root: true
  json.overwrite_keys: true

output.kafka:
  hosts: ["kafka:9092"]
  topic: weblogs
  required_acks: 1
</code></pre></div></div> <p>这端主要做的是：</p> <ul> <li>把Nginx日志采集到Kafka中，进行存储，用于Golang写的分析工具对日志数据进行分析。</li> <li>要把Nginx的日志基于Json方式格式化好放进去，好让工具解析。</li> <li>hosts: [“kafka:9092”] 这个地方的「kafka」可以替换成kafka的域名、或者ID，如果有自建的就写自建的就行了，我这里写的是docker-compose里的服务名</li> <li>topic: weblogs 这个「weblogs」可以替换成你想要的日志名称，我建议就用这个，因为默认就是分析Web日志。</li> </ul> <h3 id="nginx基础配置"> <a href="#nginx基础配置" class="anchor-heading" aria-labelledby="nginx基础配置"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Nginx基础配置 </h3> <p>在nginx这一端，也要做些轻微改动，如果本身就是JSON格式，对一下配置就可以，主要看 <strong>log_format</strong> 的 <strong>log_json</strong>这个部分，因为里面的字段都是对应的，如果已经有了Nginx的配置，就加一个这个就行。</p> <p>这里我们自己用的是openresty，用原生的Nginx也可以的，不限制具体用哪个。</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>worker_processes  auto;
#error_log         "/opt/bitnami/nginx/logs/error.log";
pid               "/tmp/nginx.pid";

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    log_format    main '$remote_addr - $remote_user [$time_local]'
                       '"$request" $status  $body_bytes_sent "$http_referer" '
                       '"$http_user_agent" "$http_x_forwarded_for" "$http_host" "$request_time" "$upstream_response_time" "$request_body"';
    #access_log    "/opt/bitnami/nginx/logs/access.log" main;
    log_format    log_json '{"@timestamp": "$time_local","request_body":"$request_body","remote_addr":"$remote_addr","http_host":"$http_host","request":"$request","status":"$status","body_bytes_sents":"$body_bytes_sent","req_time":"$request_time","http_user_agent":"$http_user_agent", "http_referer":"$http_referer", "request_method":"$request_method", "http_x_forwarded_for":"$http_x_forwarded_for"}';
    #access_log    "/usr/local/openresty/nginx/logs/access.log" log_json;
    add_header    X-Frame-Options SAMEORIGIN;

    client_body_temp_path  "/tmp/client_body" 1 2;
    proxy_temp_path        "/tmp/proxy" 1 2;
    fastcgi_temp_path      "/tmp/fastcgi" 1 2;
    scgi_temp_path         "/tmp/scgi" 1 2;
    uwsgi_temp_path        "/tmp/uwsgi" 1 2;
    client_body_buffer_size 1024k;
    fastcgi_buffers 32 16k;
    sendfile           on;
    gzip               on;
    gzip_http_version  1.0;
    gzip_comp_level    2;
    gzip_proxied       any;
    gzip_types         text/plain text/css application/javascript text/xml application/xml+rss;
    keepalive_timeout  65;
    client_max_body_size 80M;
    server_tokens off;

    #include  "/opt/bitnami/nginx/conf/server_blocks/*.conf";

    # HTTP Server
    server {
        lua_need_request_body on;
    	access_log    "/usr/local/openresty/nginx/logs/access.log" log_json;
        listen  8080;
        server_name  api.example.com;

        location / {
            proxy_pass "http://www.aidolphins.com";
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	    root html;
	    index index.html index.htm;
        }
    }
}
</code></pre></div></div> <hr> <footer> <p><a href="#top" id="back-to-top">Back to top</a></p> <p class="text-small text-grey-dk-100 mb-0">Copyright &copy; 北京元豚科技有限公司 - www.aidolphins.com 2020~2022</p> <div class="d-flex mt-2"> <p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/smarttang/w3a_soc_doc/tree/master/docs/overview/w3a-nginx-collect.md" id="edit-this-page">Edit this page on GitHub.</a> </p> </div> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
